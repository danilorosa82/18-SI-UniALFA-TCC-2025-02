<!-- Página inicial (Dashboard) -->
<!DOCTYPE html>
<!-- Puxa o layout principal -->
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout :: layout (~{::title/text()}, ~{::section}, ~{::script})}">
<head>
    <title>Dashboard - AlberguePro</title>
</head>
<body>
<section>
    <!-- Linha de Caixas de Informação -->
    <div class="row">
        <!-- Acolhidos Ativos -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-info">
                <div class="inner">
                    <h3 th:text="${dashboard.totalAcolhidos}">0</h3>
                    <p>Acolhidos Ativos</p>
                </div>
                <div class="icon"><i class="fas fa-users"></i></div>
            </div>
        </div>

        <!-- Leitos -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
                <div class="inner">
                    <h3 th:text="${dashboard.leitosLivres} + ' / ' + ${dashboard.totalLeitos}">0 / 0</h3>
                    <p>Leitos Livres</p>
                </div>
                <div class="icon"><i class="fas fa-bed"></i></div>
            </div>
        </div>

        <!-- Quartos -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
                <div class="inner">
                    <h3 th:text="${dashboard.quartosLivres} + ' / ' + ${dashboard.totalQuartos}">0 / 0</h3>
                    <p>Quartos Livres</p>
                </div>
                <div class="icon"><i class="fas fa-door-open"></i></div>
            </div>
        </div>

        <!-- Total de Usuários -->
        <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
                <div class="inner">
                    <h3 th:text="${dashboard.totalUsuarios}">0</h3>
                    <p>Usuários do Sistema</p>
                </div>
                <div class="icon"><i class="fas fa-user-shield"></i></div>
            </div>
        </div>
    </div>

    <!-- Linha dos Gráficos -->
    <div class="row">
        <!-- Coluna da Esquerda -->
        <div class="col-md-6 d-flex flex-column">
            <!-- Gráfico de Patrimônio -->
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title">Patrimônio por Status</h3>
                </div>
                <div class="card-body">
                    <div id="chartPatrimonio" style="min-height: 350px;"></div>
                    <div th:if="${#maps.isEmpty(dashboard.patrimonioPorStatus)}" class="text-center p-3">
                        <p class="text-muted">Nenhum patrimônio cadastrado</p>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Leitos -->
            <div class="card card-info card-outline mt-3">
                <div class="card-header">
                    <h3 class="card-title">Situação dos Leitos</h3>
                </div>
                <div class="card-body">
                    <div id="chartLeitos" style="min-height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Coluna da Direita -->
        <div class="col-md-6">
            <!-- Gráfico de Estoque Baixo -->
            <div class="card card-danger card-outline">
                <div class="card-header">
                    <h3 class="card-title">Produtos com Estoque Baixo (Top 10)</h3>
                </div>
                <div class="card-body">
                    <div id="chartEstoque" style="min-height: 730px;"></div>
                    <div th:if="${produtosBaixoEstoque.source.isEmpty()}" class="text-center p-3">
                        <p class="text-muted">Nenhum produto com estoque baixo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Dashboard charts initialization started');
        
        // Dados do Patrimônio
        var patrimonioData = /*[[${dashboard.patrimonioPorStatus}]]*/ {};
        console.log('Patrimonio Data:', patrimonioData);
        
        if (Object.keys(patrimonioData).length > 0) {
            var patrimonioLabels = [];
            var patrimonioValues = [];
            var patrimonioColors = [];
            
            // Cores para cada status (seguindo paleta do site)
            var statusColors = {
                'Em Uso': '#007bff',
                'Disponivel': '#28a745',
                'Em Manutencao': '#ffc107',
                'Baixado': '#dc3545'
            };
            
            for (var key in patrimonioData) {
                patrimonioLabels.push(key);
                patrimonioValues.push(patrimonioData[key]);
                patrimonioColors.push(statusColors[key] || '#6c757d');
            }
            
            var optionsPatrimonio = {
                series: patrimonioValues,
                chart: {
                    type: 'donut',
                    height: 350,
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    toolbar: {
                        show: true
                    }
                },
                labels: patrimonioLabels,
                colors: patrimonioColors,
                legend: {
                    position: 'bottom',
                    fontSize: '14px',
                    fontWeight: 500,
                    markers: {
                        width: 12,
                        height: 12,
                        radius: 3
                    }
                },
                responsive: [{
                    breakpoint: 480,
                    options: {
                        chart: {
                            width: 300
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }],
                dataLabels: {
                    enabled: true,
                    formatter: function(val, opts) {
                        return opts.w.config.series[opts.seriesIndex];
                    },
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold',
                        colors: ['#fff']
                    },
                    dropShadow: {
                        enabled: false
                    }
                },
                plotOptions: {
                    pie: {
                        donut: {
                            size: '65%',
                            labels: {
                                show: true,
                                name: {
                                    show: true,
                                    fontSize: '16px',
                                    fontWeight: 600,
                                    color: '#343a40'
                                },
                                value: {
                                    show: true,
                                    fontSize: '24px',
                                    fontWeight: 700,
                                    color: '#007bff'
                                },
                                total: {
                                    show: true,
                                    label: 'Total',
                                    fontSize: '14px',
                                    fontWeight: 600,
                                    color: '#6c757d',
                                    formatter: function (w) {
                                        return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                                    }
                                }
                            }
                        }
                    }
                },
                tooltip: {
                    theme: 'light',
                    y: {
                        formatter: function(val) {
                            return val + " itens";
                        }
                    }
                }
            };
            
            var chartPatrimonio = new ApexCharts(document.querySelector("#chartPatrimonio"), optionsPatrimonio);
            chartPatrimonio.render();
            console.log('Patrimonio chart rendered');
        }
        
        // Dados dos Leitos
        var leitosOcupados = /*[[${dashboard.leitosOcupados}]]*/ 0;
        var leitosLivres = /*[[${dashboard.leitosLivres}]]*/ 0;
        console.log('Leitos - Ocupados:', leitosOcupados, 'Livres:', leitosLivres);
        
        var optionsLeitos = {
            series: [{
                name: 'Quantidade',
                data: [leitosOcupados, leitosLivres]
            }],
            chart: {
                type: 'bar',
                height: 350,
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                toolbar: {
                    show: true
                }
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    barHeight: '50%',
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            colors: ['#dc3545', '#28a745'],
            dataLabels: {
                enabled: true,
                offsetX: 30,
                style: {
                    fontSize: '14px',
                    fontWeight: 'bold',
                    colors: ['#fff']
                }
            },
            xaxis: {
                categories: ['Ocupados', 'Livres'],
                title: {
                    text: 'Quantidade de Leitos',
                    style: {
                        fontSize: '14px',
                        fontWeight: 600,
                        color: '#343a40'
                    }
                },
                labels: {
                    style: {
                        colors: '#6c757d',
                        fontSize: '12px'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Status',
                    style: {
                        fontSize: '14px',
                        fontWeight: 600,
                        color: '#343a40'
                    }
                },
                labels: {
                    style: {
                        colors: '#6c757d',
                        fontSize: '13px',
                        fontWeight: 500
                    }
                }
            },
            legend: {
                show: false
            },
            tooltip: {
                theme: 'light',
                y: {
                    formatter: function(val) {
                        return val + " leitos";
                    }
                }
            },
            grid: {
                borderColor: '#e9ecef',
                strokeDashArray: 3
            }
        };
        
        var chartLeitos = new ApexCharts(document.querySelector("#chartLeitos"), optionsLeitos);
        chartLeitos.render();
        console.log('Leitos chart rendered');
        
        // Dados do Estoque
        var produtosEstoque = /*[[${produtosBaixoEstoque.source}]]*/ [];
        console.log('Produtos Estoque:', produtosEstoque);
        
        if (produtosEstoque.length > 0) {
            // Pegar apenas os 10 primeiros produtos
            var top10Produtos = produtosEstoque.slice(0, 10);
            var produtosNomes = [];
            var produtosQuantidades = [];
            
            top10Produtos.forEach(function(produto) {
                produtosNomes.push(produto.nome);
                produtosQuantidades.push(produto.quantidade);
            });
            
            var optionsEstoque = {
                series: [{
                    name: 'Quantidade',
                    data: produtosQuantidades
                }],
                chart: {
                    type: 'bar',
                    height: 730,
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                    toolbar: {
                        show: true
                    }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        barHeight: '70%',
                        dataLabels: {
                            position: 'top'
                        }
                    }
                },
                colors: ['#dc3545'],
                dataLabels: {
                    enabled: true,
                    offsetX: 30,
                    style: {
                        fontSize: '12px',
                        fontWeight: 'bold',
                        colors: ['#fff']
                    }
                },
                xaxis: {
                    categories: produtosNomes,
                    title: {
                        text: 'Quantidade em Estoque',
                        style: {
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#343a40'
                        }
                    },
                    labels: {
                        style: {
                            colors: '#6c757d',
                            fontSize: '12px'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Produtos',
                        style: {
                            fontSize: '14px',
                            fontWeight: 600,
                            color: '#343a40'
                        }
                    },
                    labels: {
                        style: {
                            colors: '#6c757d',
                            fontSize: '12px'
                        },
                        maxWidth: 150
                    }
                },
                tooltip: {
                    theme: 'light',
                    y: {
                        formatter: function(val) {
                            return val + " unidades";
                        }
                    }
                },
                grid: {
                    borderColor: '#e9ecef',
                    strokeDashArray: 3,
                    row: {
                        colors: ['#f8f9fa', 'transparent'],
                        opacity: 0.5
                    }
                }
            };
            
            var chartEstoque = new ApexCharts(document.querySelector("#chartEstoque"), optionsEstoque);
            chartEstoque.render();
            console.log('Estoque chart rendered');
        }
    });
</script>
</body>
</html>